name: libndt

docker: bassosimone/mk-debian
docker_tc_disabled: true

amalgamate:
  libndt.hpp:
  - libndt/api.hpp
  - libndt/impl.hpp

function_checks:
- name: strtonum
  define: LIBNDT_HAVE_STRTONUM

symbol_checks:
- name: SO_NOSIGPIPE
  header: sys/socket.h
  define: LIBNDT_HAVE_SO_NOSIGPIPE
- name: MSG_NOSIGNAL
  header: sys/socket.h
  define: LIBNDT_HAVE_MSG_NOSIGNAL

dependencies:
- github.com/adishavit/argh
- github.com/catchorg/catch2
- github.com/curl/curl
- github.com/measurement-kit/generic-assets
- github.com/nlohmann/json
- github.com/openssl/openssl

targets:
  executables:
    libndt-client:
      compile: [libndt-client.cpp]
    tests-curl:
      compile: [curlx_test.cpp]
    tests-libndt:
      compile: [libndt_test.cpp strtonum_test.cpp]

tests:
  curl_unit_tests:
    command: tests-curl
  other_unit_tests:
    command: tests-libndt
  simple_test:
    command: libndt-client -download -upload -verbose
  json_test:
    command: libndt-client -verbose -json -download -upload
  websocket_test:
    command: libndt-client -verbose -websocket -download -upload
  tls_test:
    command: libndt-client -ca-bundle-path .mkbuild/download/ca-bundle.pem
                           -verbose -download -upload -tls -json
  modern_test:
    command: libndt-client -ca-bundle-path .mkbuild/download/ca-bundle.pem
                           -verbose -download -upload -tls -json -websocket
